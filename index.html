<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ä½œæ•ˆç‡ç—›é»èª¿æŸ¥ - å³æ™‚çµ±è¨ˆ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI','Microsoft JhengHei',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px
    }
    .container{max-width:900px;margin:0 auto}
    .header{text-align:center;color:#fff;margin-bottom:30px;animation:fadeInDown .8s ease}
    .header h1{font-size:2.5em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .header p{font-size:1.2em;opacity:.9}
    .card{
      background:#fff;border-radius:20px;padding:30px;margin-bottom:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.3);animation:fadeInUp .8s ease
    }
    .question-block{margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #f0f0f0}
    .question-block:last-child{border-bottom:none}
    .question-title{font-size:1.3em;color:#667eea;margin-bottom:15px;font-weight:700}
    .options-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px}
    .option-label{
      display:flex;align-items:center;padding:12px;background:#f8f9fa;border-radius:10px;
      cursor:pointer;transition:all .3s ease
    }
    .option-label:hover{background:#e9ecef;transform:translateX(5px)}
    .option-label input{margin-right:10px;width:18px;height:18px;cursor:pointer}
    .input-field{
      width:100%;padding:15px;font-size:1.1em;border:2px solid #e0e0e0;border-radius:10px;
      margin-top:10px;transition:border-color .3s ease
    }
    .input-field:focus{outline:none;border-color:#667eea}
    .submit-btn{
      width:100%;padding:18px;font-size:1.3em;font-weight:700;color:#fff;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      border:none;border-radius:15px;cursor:pointer;transition:all .3s ease;margin-top:20px
    }
    .submit-btn:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(102,126,234,.4)}
    .submit-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .stats-section{display:none}
    .stats-section.active{display:block}
    .stat-card{
      background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
      border-radius:15px;padding:20px;margin-bottom:20px
    }
    .stat-title{font-size:1.5em;color:#764ba2;margin-bottom:15px;font-weight:700}
    .bar-item{margin-bottom:12px}
    .bar-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:.95em}
    .bar-bg{background:#e0e0e0;height:30px;border-radius:15px;overflow:hidden;position:relative}
    .bar-fill{
      height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);
      border-radius:15px;transition:width 1s ease;display:flex;align-items:center;justify-content:flex-end;
      padding-right:10px;color:#fff;font-weight:700
    }
    .fun-stats{
      background:linear-gradient(135deg,#ffeaa7 0%,#fdcb6e 100%);
      border-radius:15px;padding:25px;margin-top:20px;text-align:center
    }
    .fun-stats h3{color:#d63031;font-size:1.8em;margin-bottom:15px}
    .fun-number{font-size:3em;font-weight:700;color:#e17055;margin:10px 0;animation:pulse 2s infinite}
    .toggle-view{text-align:center;margin-top:20px}
    .toggle-btn{
      padding:12px 30px;font-size:1.1em;color:#fff;background:#764ba2;border:none;border-radius:10px;
      cursor:pointer;transition:all .3s ease
    }
    .toggle-btn:hover{background:#667eea;transform:scale(1.05)}
    .response-count{text-align:center;color:#fff;font-size:1.2em;margin-bottom:20px}
    .toast{
      position:fixed;right:20px;bottom:20px;background:rgba(0,0,0,.8);color:#fff;
      padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(10px);
      transition:all .25s ease;max-width:360px
    }
    .toast.show{opacity:1;transform:translateY(0)}
    .hint{
      margin-top:8px;font-size:.95em;opacity:.9;color:#fff;text-align:center
    }
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    @media (max-width:768px){
      .header h1{font-size:1.8em}
      .options-grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸš€ å·¥ä½œæ•ˆç‡ç—›é»èª¿æŸ¥</h1>
    <p>åŒ¿åå¡«å¯«ï¼Œç«‹å³çœ‹åˆ°å…¨é«”å³æ™‚çµ±è¨ˆï¼Œä¸€èµ·æ‰¾å‡ºæ”¹å–„æ–¹å‘ï¼</p>
  </div>

  <div class="response-count" id="responseCount">
    å·²æ”¶é›† <strong id="totalResponses">0</strong> ä»½å›æ‡‰ ğŸ‰
  </div>
  <div class="hint">
    ğŸ“Œ å…§éƒ¨ Demo ç‰ˆï¼šè³‡æ–™å­˜åˆ° JSONBinï¼ˆæ´»å‹•çµæŸè«‹åˆª bin / æ› keyï¼‰
  </div>

  <!-- Survey Form -->
  <div class="card survey-form" id="surveyForm">
    <form id="mainForm">
      <!-- Question 1 -->
      <div class="question-block">
        <div class="question-title">1. ä½ æœ€æƒ³æ”¹å–„çš„å·¥ä½œé¡å‹ (å¯å¤šé¸) ğŸ“‹</div>
        <div class="options-grid">
          <label class="option-label"><input type="checkbox" name="q1" value="å ±å‘Šæ•´ç†"><span>å ±å‘Šæ•´ç†</span></label>
          <label class="option-label"><input type="checkbox" name="q1" value="æœƒè­°è¿½è¹¤"><span>æœƒè­°è¿½è¹¤</span></label>
          <label class="option-label"><input type="checkbox" name="q1" value="è³‡æ–™æŸ¥æ‰¾"><span>è³‡æ–™æŸ¥æ‰¾</span></label>
          <label class="option-label"><input type="checkbox" name="q1" value="è·¨éƒ¨é–€æºé€š"><span>è·¨éƒ¨é–€æºé€š</span></label>
          <label class="option-label"><input type="checkbox" name="q1" value="è¦æ ¼æ§ç®¡"><span>è¦æ ¼æ§ç®¡</span></label>
          <label class="option-label"><input type="checkbox" name="q1" value="å®¢è¨´/issue"><span>å®¢è¨´/issue</span></label>
          <label class="option-label"><input type="checkbox" name="q1" value="å…¶ä»–"><span>å…¶ä»–</span></label>
        </div>
      </div>

      <!-- Question 2 -->
      <div class="question-block">
        <div class="question-title">2. æœ€æµªè²»æ™‚é–“çš„æ˜¯å“ªä¸€æ­¥ï¼Ÿ(å¯å¤šé¸) â°</div>
        <div class="options-grid">
          <label class="option-label"><input type="checkbox" name="q2" value="å¯«å ±å‘Š"><span>å¯«å ±å‘Š</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="é‡è¤‡è²¼ä¸Šæ•´ç†"><span>é‡è¤‡è²¼ä¸Šæ•´ç†</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="è³‡æ–™æ•´ç†"><span>è³‡æ–™æ•´ç†</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="è¿½äººå›è¦†"><span>è¿½äººå›è¦†</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="ç‰ˆæœ¬èˆ‡è³‡æ–™æ··äº‚"><span>ç‰ˆæœ¬èˆ‡è³‡æ–™æ··äº‚</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="éŒ¯èª¤é‡å·¥"><span>éŒ¯èª¤é‡å·¥</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="å¯¦é©—è§£æ"><span>å¯¦é©—è§£æ</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="layout"><span>layout</span></label>
          <label class="option-label"><input type="checkbox" name="q2" value="å…¶ä»–"><span>å…¶ä»–</span></label>
        </div>
      </div>

      <!-- Question 3 -->
      <div class="question-block">
        <div class="question-title">3. ç›®å‰æ¯æ¬¡å¤§æ¦‚èŠ±å¤šä¹…ï¼Ÿ(åˆ†é˜) â±ï¸</div>
        <input type="number" name="q3" class="input-field" placeholder="åªå¡«æ•¸å­—ï¼Œä¾‹å¦‚ï¼š90" min="1" required>
      </div>

      <!-- Question 4 -->
      <div class="question-block">
        <div class="question-title">4. é »ç‡ï¼ˆæ¯é€±å¤§ç´„å¹¾æ¬¡ï¼Ÿï¼‰ğŸ“…</div>
        <input type="number" name="q4" class="input-field" placeholder="åªå¡«æ•¸å­—ï¼Œä¾‹å¦‚ï¼š6" min="1" required>
      </div>

      <!-- Question 5 -->
      <div class="question-block">
        <div class="question-title">5. é€ æˆä½æ•ˆç‡çš„åŸå›  (å¯å¤šé¸) ğŸ”</div>
        <div class="options-grid">
          <label class="option-label"><input type="checkbox" name="q5" value="è¦åŠƒä¸è¶³"><span>è¦åŠƒä¸è¶³</span></label>
          <label class="option-label"><input type="checkbox" name="q5" value="æœƒè­°æ™‚é–“å¤ªé•·"><span>æœƒè­°æ™‚é–“å¤ªé•·</span></label>
          <label class="option-label"><input type="checkbox" name="q5" value="è³‡æ–™åˆ†æ•£"><span>è³‡æ–™åˆ†æ•£</span></label>
          <label class="option-label"><input type="checkbox" name="q5" value="è·¨éƒ¨é–€ç­‰å¾…"><span>è·¨éƒ¨é–€ç­‰å¾…</span></label>
          <label class="option-label"><input type="checkbox" name="q5" value="æ¬Šè²¬ä¸æ¸…"><span>æ¬Šè²¬ä¸æ¸…</span></label>
          <label class="option-label"><input type="checkbox" name="q5" value="æ©Ÿåˆ¶ä¸æ˜"><span>æ©Ÿåˆ¶ä¸æ˜</span></label>
          <label class="option-label"><input type="checkbox" name="q5" value="å…¶ä»–"><span>å…¶ä»–</span></label>
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">é€å‡ºå•å· âœ¨</button>
    </form>
  </div>

  <!-- Statistics Section -->
  <div class="card stats-section" id="statsSection">
    <h2 style="text-align:center;color:#667eea;margin-bottom:30px;">ğŸ“Š å³æ™‚çµ±è¨ˆçµæœ</h2>

    <div class="stat-card">
      <div class="stat-title">æœ€æƒ³æ”¹å–„çš„å·¥ä½œé¡å‹</div>
      <div id="q1Stats" class="bar-chart"></div>
    </div>

    <div class="stat-card">
      <div class="stat-title">æœ€æµªè²»æ™‚é–“çš„æ­¥é©Ÿ</div>
      <div id="q2Stats" class="bar-chart"></div>
    </div>

    <div class="stat-card">
      <div class="stat-title">ä½æ•ˆç‡åŸå› </div>
      <div id="q5Stats" class="bar-chart"></div>
    </div>

    <div class="fun-stats">
      <h3>ğŸ’¡ æœ‰è¶£çµ±è¨ˆ</h3>
      <p>å¹³å‡æ¯æ¬¡èŠ±è²»æ™‚é–“</p>
      <div class="fun-number" id="avgTime">-- åˆ†é˜</div>
      <p>å¹³å‡æ¯é€±é »ç‡</p>
      <div class="fun-number" id="avgFreq">-- æ¬¡</div>
      <p style="margin-top:20px;font-size:1.2em;color:#d63031;">
        <strong>æ¯é€±ç¸½è¨ˆæµªè²»ï¼š<span id="weeklyWaste">--</span> å°æ™‚ ğŸ˜±</strong>
      </p>
      <p style="margin-top:10px;color:#333;font-weight:700;">
        ğŸ‘‘ æœ€å¤§é»‘æ´ï¼š<span id="topSink">--</span>
      </p>
    </div>
  </div>

  <div class="toggle-view">
    <button class="toggle-btn" id="toggleBtn" onclick="toggleView()">æŸ¥çœ‹çµ±è¨ˆçµæœ ğŸ“ˆ</button>
    <button class="toggle-btn" onclick="resetData()" style="background:#e17055;margin-left:10px;">æ¸…é™¤æ‰€æœ‰è³‡æ–™ ğŸ—‘ï¸</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ===== JSONBin config (A: Private bin + Master Key; demo-only) =====
  // 1) Create a JSONBin with initial content: {"responses":[]}
  // 2) Fill in BIN_ID and MASTER_KEY here
  const JSONBIN_BIN_ID = "698e9bbcd0ea881f40b66e06";
  const JSONBIN_MASTER_KEY = "$2a$10$N995urZyU3QEUGJPJnQWG.j6G08CY92yUHfHBv5hNmJzXUeP/Mqse";

  const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
  const JSONBIN_GET_URL = `${JSONBIN_URL}/latest`;

  // Admin reset password (change it)
  const ADMIN_PASSWORD = "admin2026";

  // Polling interval for dashboard refresh
  const POLL_MS = 5000;

  // Fun toast
  function toast(msg) {
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(() => el.classList.remove("show"), 1800);
  }

  function setSubmitDisabled(disabled) {
    const btn = document.getElementById("submitBtn");
    btn.disabled = disabled;
    btn.textContent = disabled ? "é€å‡ºä¸­..." : "é€å‡ºå•å· âœ¨";
  }

  async function getData() {
    const res = await fetch(JSONBIN_GET_URL, {
      method: "GET",
      headers: { "X-Master-Key": JSONBIN_MASTER_KEY }
    });
    if (!res.ok) throw new Error("Failed to load data from JSONBin");
    const json = await res.json();
    const record = json.record || { responses: [] };
    if (!record.responses) record.responses = [];
    return record;
  }

  async function saveData(data) {
    const res = await fetch(JSONBIN_URL, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": JSONBIN_MASTER_KEY
      },
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error("Failed to save data to JSONBin");
  }

  function createBarChart(containerId, statsObj, totalResponses) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    const entries = Object.entries(statsObj);
    if (entries.length === 0) {
      container.innerHTML = "<div style='opacity:.8'>å°šç„¡è³‡æ–™</div>";
      return;
    }

    const sorted = entries.sort((a, b) => b[1] - a[1]);

    sorted.forEach(([label, count]) => {
      const percentage = totalResponses > 0 ? ((count / totalResponses) * 100).toFixed(1) : "0.0";

      const barItem = document.createElement("div");
      barItem.className = "bar-item";
      barItem.innerHTML = `
        <div class="bar-label">
          <span>${label}</span>
          <span>${count} ç¥¨ (${percentage}%)</span>
        </div>
        <div class="bar-bg">
          <div class="bar-fill" style="width:${percentage}%"></div>
        </div>
      `;
      container.appendChild(barItem);
    });
  }

  function buildStats(responses) {
    const stats = { q1: {}, q2: {}, q5: {}, times: [], frequencies: {} };

    for (const r of responses) {
      (r.q1 || []).forEach(x => stats.q1[x] = (stats.q1[x] || 0) + 1);
      (r.q2 || []).forEach(x => stats.q2[x] = (stats.q2[x] || 0) + 1);
      (r.q5 || []).forEach(x => stats.q5[x] = (stats.q5[x] || 0) + 1);
      if (Number.isFinite(r.q3)) stats.times.push(r.q3);
      if (Number.isFinite(r.q4)) stats.frequencies[r.q4] = (stats.frequencies[r.q4] || 0) + 1;
    }

    return stats;
  }

  function getTopKey(obj) {
    const entries = Object.entries(obj);
    if (entries.length === 0) return "--";
    entries.sort((a, b) => b[1] - a[1]);
    return entries[0][0];
  }

  async function updateDisplay() {
    let data;
    try {
      data = await getData();
    } catch (e) {
      console.error(e);
      toast("è®€å–è³‡æ–™å¤±æ•—ï¼ˆè«‹ç¢ºèª BIN_ID / MASTER_KEYï¼‰");
      return;
    }

    const responses = data.responses || [];
    const total = responses.length;

    document.getElementById("totalResponses").textContent = total;

    if (total === 0) {
      createBarChart("q1Stats", {}, 0);
      createBarChart("q2Stats", {}, 0);
      createBarChart("q5Stats", {}, 0);
      document.getElementById("avgTime").textContent = "-- åˆ†é˜";
      document.getElementById("avgFreq").textContent = "-- æ¬¡";
      document.getElementById("weeklyWaste").textContent = "--";
      document.getElementById("topSink").textContent = "--";
      return;
    }

    const stats = buildStats(responses);

    createBarChart("q1Stats", stats.q1, total);
    createBarChart("q2Stats", stats.q2, total);
    createBarChart("q5Stats", stats.q5, total);

    const avgTime = (stats.times.reduce((a, b) => a + b, 0) / stats.times.length).toFixed(0);

    // Compute avg freq from numeric values distribution (more robust)
    const freqEntries = Object.entries(stats.frequencies).map(([k, v]) => [Number(k), v]);
    const freqSum = freqEntries.reduce((acc, [k, v]) => acc + k * v, 0);
    const freqCount = freqEntries.reduce((acc, [, v]) => acc + v, 0);
    const avgFreq = (freqSum / Math.max(1, freqCount)).toFixed(1);

    const weeklyWaste = ((avgTime * avgFreq) / 60).toFixed(1);

    document.getElementById("avgTime").textContent = avgTime + " åˆ†é˜";
    document.getElementById("avgFreq").textContent = avgFreq + " æ¬¡";
    document.getElementById("weeklyWaste").textContent = weeklyWaste;

    // Fun: biggest sink is from Q2
    document.getElementById("topSink").textContent = getTopKey(stats.q2);
  }

  function toggleView() {
    const surveyForm = document.getElementById("surveyForm");
    const statsSection = document.getElementById("statsSection");
    const toggleBtn = document.getElementById("toggleBtn");

    if (surveyForm.style.display !== "none") {
      surveyForm.style.display = "none";
      statsSection.classList.add("active");
      toggleBtn.textContent = "è¿”å›å•å· ğŸ“";
      // refresh when entering stats
      updateDisplay();
    } else {
      surveyForm.style.display = "block";
      statsSection.classList.remove("active");
      toggleBtn.textContent = "æŸ¥çœ‹çµ±è¨ˆçµæœ ğŸ“ˆ";
    }
  }

  async function resetData() {
    const password = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
    if (password === null) return;
    if (password !== ADMIN_PASSWORD) {
      alert("å¯†ç¢¼éŒ¯èª¤ï¼âŒ");
      return;
    }
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;

    try {
      await saveData({ responses: [] });
      alert("è³‡æ–™å·²æ¸…é™¤ï¼ ğŸ—‘ï¸");
      location.reload();
    } catch (e) {
      console.error(e);
      alert("æ¸…é™¤å¤±æ•—ï¼Œè«‹ç¢ºèª JSONBin è¨­å®šã€‚");
    }
  }

  // Submit handler
  document.getElementById("mainForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    setSubmitDisabled(true);

    const formData = new FormData(e.target);
    const response = {
      q1: formData.getAll("q1"),
      q2: formData.getAll("q2"),
      q3: parseInt(formData.get("q3"), 10),
      q4: parseInt(formData.get("q4"), 10),
      q5: formData.getAll("q5"),
      timestamp: new Date().toISOString()
    };

    // Basic validation
    if (response.q1.length === 0 || response.q2.length === 0 || response.q5.length === 0) {
      alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¸é …ï¼(Q1/Q2/Q5)");
      setSubmitDisabled(false);
      return;
    }
    if (!Number.isFinite(response.q3) || response.q3 <= 0 || !Number.isFinite(response.q4) || response.q4 <= 0) {
      alert("Q3/Q4 è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—ï¼");
      setSubmitDisabled(false);
      return;
    }

    try {
      // Load latest, append, save
      const data = await getData();
      data.responses = data.responses || [];
      data.responses.push(response);
      await saveData(data);

      toast("ğŸ‰ å·²é€å‡ºï¼å³æ™‚çµ±è¨ˆæ›´æ–°ä¸­...");
      e.target.reset();

      // Switch to stats view after submit
      const surveyForm = document.getElementById("surveyForm");
      if (surveyForm.style.display !== "none") toggleView();
      await updateDisplay();

    } catch (err) {
      console.error(err);
      alert("é€å‡ºå¤±æ•—ï¼šè«‹ç¢ºèª BIN_ID / MASTER_KEYï¼Œæˆ–ç¶²è·¯æ˜¯å¦å¯é€£åˆ° JSONBinã€‚");
    } finally {
      setSubmitDisabled(false);
    }
  });

  // Initialize on load
  updateDisplay();

  // Auto-refresh stats when viewing stats
  setInterval(() => {
    const statsSection = document.getElementById("statsSection");
    if (statsSection.classList.contains("active")) updateDisplay();
  }, POLL_MS);
</script>
</body>
</html>
